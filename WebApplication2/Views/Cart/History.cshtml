@model WebApplication2.Models.OrderHistoryVM
@using System.Globalization;

@{
    ViewBag.Title = "Order History";
    var selectedStatus = Context.Request.Query["status"].ToString();
}

@Html.AntiForgeryToken()

@section Scripts {
    <script src="/js/email-receipt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function () {
            // --- Enhanced Layout/Design: Card and Button Styling ---
            $(".order-card .card").addClass("shadow border-0");
            $(".order-card .card-header").addClass("bg-light border-bottom-0");
            
            // Apply consistent button styling
            $(".order-card .btn").addClass("rounded-pill px-3 fw-semibold");
            $(".order-card .btn").css({
                "min-width": "120px", 
                "margin-right": "8px",
                "transition": "all 0.3s ease",
                "position": "relative",
                "overflow": "hidden"
            });
            
            // Style specific button types
            $(".order-card .btn-outline-primary").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(0,123,255,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            $(".order-card .btn-outline-info").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(23,162,184,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            $(".order-card .btn-outline-success").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(40,167,69,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            $(".order-card .btn-outline-danger").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(220,53,69,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            $(".order-card .btn-warning").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(255,193,7,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            // Special styling for return to payment button
            $(".return-to-payment-btn").addClass("pulse-animation").hover(function() {
                $(this).css({
                    "box-shadow": "0 6px 12px rgba(255,193,7,0.4)",
                    "transform": "translateY(-2px)"
                });
            }, function() {
                $(this).css({
                    "box-shadow": "0 4px 8px rgba(255,193,7,0.25)",
                    "transform": "translateY(0)"
                });
            });
            
            $(".order-card .btn-success").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(40,167,69,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            $(".order-card .btn-secondary").addClass("border-2").hover(function() {
                $(this).css("box-shadow", "0 4px 8px rgba(108,117,125,0.25)");
            }, function() {
                $(this).css("box-shadow", "none");
            });
            
            // Add ripple effect to buttons
            $(".order-card .btn").on("click", function(e) {
                const btn = $(this);
                const x = e.pageX - btn.offset().left;
                const y = e.pageY - btn.offset().top;
                
                const ripple = $('<span class="btn-ripple"></span>');
                ripple.css({
                    left: x + 'px',
                    top: y + 'px'
                });
                
                btn.append(ripple);
                
                setTimeout(function() {
                    ripple.remove();
                }, 700);
            });
            
            // Style images
            $(".order-card img").addClass("rounded shadow-sm border");

            // --- Status Filter: AJAX filtering ---
            $('#statusFilter').off('change').on('change', function() {
                performAjaxSearch();
            });

            // --- Track Order Button: Go to Track Page with Order Number ---
            $(document).on('click', '.track-order-btn', function() {
                const orderId = $(this).data('order-id');
                window.location.href = '/Cart/Track?orderNumber=' + orderId;
            });
            
            // --- Return to Payment Button: Go directly to payment page for pending orders ---
            $(document).on('click', '.return-to-payment-btn', function() {
                const orderId = $(this).data('order-id');
                console.log('Returning to payment for order:', orderId);
                
                // Use the same URL format as fixed in TrackResult
                const paymentUrl = '@Url.Action("Payment", "Cart")/' + orderId;
                console.log('Payment URL:', paymentUrl);
                
                window.location.href = paymentUrl;
            });
            
            // --- Cancel Order Button ---
            $(document).on('click', '.cancel-order-btn', function() {
                const orderId = $(this).data('order-id');
                const modalEl = document.getElementById('cancelOrderModal');
                if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    modalEl.dataset.orderId = orderId;
                    const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    bsModal.show();
                } else {
                    // Fallback if Bootstrap JS not loaded: use confirm()
                    if (confirm('Are you sure you want to cancel this order?')) {
                        const token = $('input[name="__RequestVerificationToken"]').first().val();
                        $.ajax({
                            url: '/Cart/CancelOrder',
                            type: 'POST',
                            headers: { 'RequestVerificationToken': token },
                            data: { id: orderId, reason: '' },
                            success: function(res) {
                                if (res.success) {
                                    const card = $(`.order-card[data-order-id='${orderId}']`);
                                    if (card && card.length) {
                                        card.fadeOut(200, function(){ $(this).remove(); });
                                    } else {
                                        location.reload();
                                    }
                                } else {
                                    alert(res.message || 'Failed to cancel order.');
                                }
                            },
                            error: function() { alert('Error cancelling order.'); }
                        });
                    }
                }
            });

            // --- Confirm Cancel Order ---
            $('#confirmCancelOrder').on('click', function() {
                const modalEl = document.getElementById('cancelOrderModal');
                const orderId = modalEl ? modalEl.dataset.orderId : null;
                const reason = $('#cancelReason').val();
                const token = $('input[name="__RequestVerificationToken"]').first().val();
                $.ajax({
                    url: '/Cart/CancelOrder',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': token },
                    data: { id: orderId, reason: reason },
                    success: function(res) {
                        if (res.success) {
                            // Hide modal
                            const bsModal = bootstrap.Modal.getInstance(modalEl);
                            if (bsModal) bsModal.hide();
                            // Remove the order card from DOM for better UX
                            const card = $(`.order-card[data-order-id='${orderId}']`);
                            if (card && card.length) {
                                card.fadeOut(200, function(){
                                    $(this).remove();
                                });
                            } else {
                                location.reload();
                            }
                        } else {
                            alert(res.message || 'Failed to cancel order.');
                        }
                    },
                    error: function() { alert('Error cancelling order.'); }
                });
            });

            // --- Refund Order Button ---
            $(document).on('click', '.refund-order-btn', function() {
                const orderId = $(this).data('order-id');
                const reason = prompt('Please provide a reason for the refund (optional):') || '';
                const token = $('input[name="__RequestVerificationToken"]').first().val();
                if (!confirm('Confirm refund for Order #' + orderId + '?')) return;
                
                const orderCard = $(`.order-card[data-order-id='${orderId}']`);
                const refundBtn = $(this);
                const originalBtnText = refundBtn.html();
                
                // Show loading state
                refundBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');
                refundBtn.prop('disabled', true);
                
                $.ajax({
                    url: '/Cart/RefundOrder',
                    type: 'POST',
                    data: { id: orderId, reason: reason, __RequestVerificationToken: token },
                    success: function(res) {
                        if (res.success) {
                            // Add refund animation to the order card
                            orderCard.addClass('refund-animation');
                            
                            // Show success message
                            const successMessage = $(`
                                <div class="alert refund-success-message mt-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-check-circle fa-2x me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Refund Processed Successfully!</h5>
                                            <p class="mb-0">Order #${orderId} has been refunded and removed. Items have been restocked.</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                            $('.container.mt-3').prepend(successMessage);
                            
                            // Remove the order card after animation completes
                            setTimeout(function() {
                                orderCard.remove();
                                // Auto-hide success message after a few seconds
                                setTimeout(function() {
                                    $('.refund-success-message').fadeOut();
                                }, 3000);
                            }, 3000);
                        } else {
                            // Reset button state
                            refundBtn.html(originalBtnText);
                            refundBtn.prop('disabled', false);
                            alert(res.message || 'Failed to process refund.');
                        }
                    },
                    error: function() { 
                        // Reset button state
                        refundBtn.html(originalBtnText);
                        refundBtn.prop('disabled', false);
                        alert('Error processing refund.'); 
                    }
                });
            });
            
            // --- Reorder Button: Add items to cart ---
            $(document).on('click', '.reorder-btn', function() {
                const orderId = $(this).data('order-id');
                const btn = $(this);
                
                // Show loading state
                const originalText = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');
                btn.prop('disabled', true);
                
                // Send AJAX request to reorder endpoint
                $.ajax({
                    url: '/Cart/Reorder',
                    type: 'POST',
                    data: { orderId: orderId },
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            const successAlert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                '<i class="fas fa-check-circle me-2"></i> Items added to cart successfully!' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                '</div>');
                            $('.container.mt-3').prepend(successAlert);
                            
                            // Redirect to cart page after a short delay
                            setTimeout(function() {
                                window.location.href = '/Cart';
                            }, 1000);
                        } else {
                            // Show error message
                            const errorAlert = $('<div class="alert alert-dismissible fade show" role="alert">' +
                                '<i class="fas fa-exclamation-circle me-2"></i> ' + (response.message || 'Failed to add items to cart.') +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                '</div>');
                            $('.container.mt-3').prepend(errorAlert);
                            
                            // Reset button state
                            btn.html(originalText);
                            btn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        // Show error message
                        const errorAlert = $('<div class="alert alert-dismissible fade show" role="alert">' +
                            '<i class="fas fa-exclamation-circle me-2"></i> An error occurred while processing your request.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                            '</div>');
                        $('.container.mt-3').prepend(errorAlert);
                        
                        // Reset button state
                        btn.html(originalText);
                        btn.prop('disabled', false);
                    }
                });
            });
            
            // --- AJAX Search Functionality ---
            $('#searchBtn').on('click', function() {
                performAjaxSearch();
            });
            
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    performAjaxSearch();
                }
            });
            
            // Real-time search with debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    performAjaxSearch();
                }, 500); // Wait 500ms after user stops typing
            });
            
            // Clear search functionality
            $('#clearSearchBtn').on('click', function() {
                $('#searchInput').val('');
                performAjaxSearch(); // This will show all orders
            });
            
            // --- Sorting Functionality ---
            $('#sortOptions').on('change', function() {
                const sortOption = $(this).val();
                sortOrders(sortOption);
            });
            
            // --- Load Chart Data ---
            loadChartData();
            
            // --- Initialize Pagination ---
            initPagination();
        });
        
        // Function to sort orders based on selected option
        function sortOrders(sortOption) {
            const orderCards = $('.order-card').toArray();
            
            // Sort the order cards based on the selected option
            orderCards.sort(function(a, b) {
                const cardA = $(a);
                const cardB = $(b);
                
                switch(sortOption) {
                    case 'date-newest':
                        const dateA = new Date(cardA.data('order-date'));
                        const dateB = new Date(cardB.data('order-date'));
                        return dateB - dateA; // Newest first
                    case 'date-oldest':
                        const dateC = new Date(cardA.data('order-date'));
                        const dateD = new Date(cardB.data('order-date'));
                        return dateC - dateD; // Oldest first
                    case 'price-highest':
                        const priceA = parseFloat(cardA.data('order-total'));
                        const priceB = parseFloat(cardB.data('order-total'));
                        return priceB - priceA; // Highest first
                    case 'price-lowest':
                        const priceC = parseFloat(cardA.data('order-total'));
                        const priceD = parseFloat(cardB.data('order-total'));
                        return priceC - priceD; // Lowest first
                    case 'status-asc':
                        const statusA = cardA.data('order-status').toLowerCase();
                        const statusB = cardB.data('order-status').toLowerCase();
                        return statusA.localeCompare(statusB);
                    case 'status-desc':
                        const statusC = cardA.data('order-status').toLowerCase();
                        const statusD = cardB.data('order-status').toLowerCase();
                        return statusD.localeCompare(statusC);
                    case 'id-asc':
                        const idA = parseInt(cardA.data('order-id'));
                        const idB = parseInt(cardB.data('order-id'));
                        return idA - idB;
                    case 'id-desc':
                        const idC = parseInt(cardA.data('order-id'));
                        const idD = parseInt(cardB.data('order-id'));
                        return idD - idC;
                    default:
                        return 0; // No sorting
                }
            });
            
            // Reappend the sorted cards to the container
            const container = $('#ordersList');
            $.each(orderCards, function(index, card) {
                container.append(card);
            });
            
            // Show animation effect for sorting
            $('.order-card').addClass('sort-animation');
            setTimeout(function() {
                $('.order-card').removeClass('sort-animation');
            }, 500);
            
            // Reinitialize pagination after sorting
            initPagination();
        }
        
        // Global variables for pagination
        let currentPage = 1;
        const ordersPerPage = 5;
        let filteredOrders = [];
        
        // Function to initialize pagination
        function initPagination() {
            // Get all visible order cards
            filteredOrders = $('.order-card:visible').toArray();
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            
            // Reset to first page when filtering changes
            currentPage = 1;
            
            // Update pagination controls
            updatePaginationControls(totalPages);
            
            // Show orders for current page
            showOrdersForPage(currentPage);
        }
        
        // Function to update pagination controls
        function updatePaginationControls(totalPages) {
            // Clear existing pagination
            $('.pagination-controls').remove();
            
            if (totalPages <= 1) {
                return; // No need for pagination
            }
            
            // Create pagination controls
            let paginationHtml = '<div class="pagination-controls">';
            
            // First page button
            paginationHtml += `<button class="page-btn first-btn" ${currentPage === 1 ? 'disabled' : ''} title="First Page">
                <i class="fas fa-angle-double-left"></i>
            </button>`;
            
            // Previous button
            paginationHtml += `<button class="page-btn prev-btn" ${currentPage === 1 ? 'disabled' : ''} title="Previous Page">
                <i class="fas fa-chevron-left"></i> Prev
            </button>`;
            
            // Page buttons (show max 5 pages)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            // Show ellipsis for first pages if needed
            if (startPage > 1) {
                paginationHtml += `<button class="page-btn" data-page="1">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span class="page-ellipsis">...</span>`;
                }
            }
            
            // Show page buttons
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            
            // Show ellipsis for last pages if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<span class="page-ellipsis">...</span>`;
                }
                paginationHtml += `<button class="page-btn" data-page="${totalPages}">${totalPages}</button>`;
            }
            
            // Next button
            paginationHtml += `<button class="page-btn next-btn" ${currentPage === totalPages ? 'disabled' : ''} title="Next Page">
                Next <i class="fas fa-chevron-right"></i>
            </button>`;
            
            // Last page button
            paginationHtml += `<button class="page-btn last-btn" ${currentPage === totalPages ? 'disabled' : ''} title="Last Page">
                <i class="fas fa-angle-double-right"></i>
            </button>`;
            
            // Page info
            paginationHtml += `<span class="page-info">
                <i class="fas fa-file-alt me-1"></i> Page ${currentPage} of ${totalPages}
            </span>`;
            
            paginationHtml += '</div>';
            
            // Append pagination controls
            $('#ordersList').after(paginationHtml);
            
            // Add event listeners
            $('.page-btn[data-page]').on('click', function() {
                currentPage = parseInt($(this).data('page'));
                showOrdersForPage(currentPage);
                updatePaginationControls(totalPages);
            });
            
            $('.prev-btn').on('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    showOrdersForPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            });
            
            $('.next-btn').on('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    showOrdersForPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            });
            
            $('.first-btn').on('click', function() {
                if (currentPage > 1) {
                    currentPage = 1;
                    showOrdersForPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            });
            
            $('.last-btn').on('click', function() {
                if (currentPage < totalPages) {
                    currentPage = totalPages;
                    showOrdersForPage(currentPage);
                    updatePaginationControls(totalPages);
                }
            });
        }
        
        // Function to show orders for the current page
        function showOrdersForPage(page) {
            // Hide all orders
            $('.order-card').hide();
            
            // Calculate start and end index
            const startIndex = (page - 1) * ordersPerPage;
            const endIndex = Math.min(startIndex + ordersPerPage, filteredOrders.length);
            
            // Show orders for current page with animation
            for (let i = startIndex; i < endIndex; i++) {
                const orderCard = $(filteredOrders[i]);
                orderCard.addClass('page-transition');
                orderCard.show();
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    orderCard.removeClass('page-transition');
                }, 400); // Match the animation duration
            }
            
            // No auto-scrolling when paginating - let users stay where they are
        }
        
        // AJAX function to perform server-side search on orders
        function performAjaxSearch() {
            const searchTerm = $('#searchInput').val().trim();
            const selectedStatus = $('#statusFilter').val();
            
            // Show loading state
            showSearchLoading(true);
            
            // Remove previous messages
            $('#no-results-message').remove();
            $('#search-results-info').remove();
            
            $.ajax({
                url: '/Cart/SearchOrders',
                type: 'GET',
                data: {
                    searchTerm: searchTerm,
                    status: selectedStatus
                },
                success: function(response) {
                    if (response.success) {
                        // Clear existing orders
                        $('#ordersList').empty();
                        
                        if (response.orders && response.orders.length > 0) {
                            // Render new orders
                            renderOrders(response.orders);
                            
                            // Show search results info
                            showSearchResultsInfo(response.totalCount, searchTerm, selectedStatus);
                            
                            // Reinitialize pagination
                            initPagination();
                        } else {
                            // Show no results message
                            showNoResultsMessage(searchTerm, selectedStatus);
                        }
                    } else {
                        showSearchError('Failed to search orders. Please try again.');
                    }
                },
                error: function() {
                    showSearchError('An error occurred while searching. Please try again.');
                },
                complete: function() {
                    showSearchLoading(false);
                }
            });
        }
        
        // Helper function to show/hide search loading state
        function showSearchLoading(show) {
            if (show) {
                $('#searchBtn').html('<i class="fas fa-spinner fa-spin me-1"></i> Searching...');
                $('#searchBtn').prop('disabled', true);
                $('#searchInput').prop('disabled', true);
                $('#statusFilter').prop('disabled', true);
            } else {
                $('#searchBtn').html('<i class="fas fa-search me-1"></i> Search');
                $('#searchBtn').prop('disabled', false);
                $('#searchInput').prop('disabled', false);
                $('#statusFilter').prop('disabled', false);
            }
        }
        
        // Helper function to show search results info
        function showSearchResultsInfo(count, searchTerm, status) {
            let message = `Found ${count} order${count !== 1 ? 's' : ''}`;
            
            if (searchTerm && status) {
                message += ` matching "${searchTerm}" with status "${status}"`;
            } else if (searchTerm) {
                message += ` matching "${searchTerm}"`;
            } else if (status) {
                message += ` with status "${status}"`;
            }
            
            const infoHtml = `
                <div id="search-results-info" class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>${message}
                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="clearAllFilters();">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
            `;
            $('#orderListingContainer').prepend(infoHtml);
        }
        
        // Helper function to show no results message
        function showNoResultsMessage(searchTerm, status) {
            let message = 'No orders found';
            let searchCriteria = [];
            
            if (searchTerm) searchCriteria.push(`search term "${searchTerm}"`);
            if (status) searchCriteria.push(`status "${status}"`);
            
            if (searchCriteria.length > 0) {
                message += ` for ${searchCriteria.join(' and ')}`;
            }
            
            const noResultsHtml = `
                <div id="no-results-message" class="alert alert-warning mt-4 text-center">
                    <div class="mb-3">
                        <i class="fas fa-search fa-2x text-muted mb-2"></i>
                        <h5>${message}</h5>
                    </div>
                    <div class="small text-muted">
                        <p class="mb-2"><strong>Search tips:</strong></p>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><i class="fas fa-lightbulb me-1"></i> <strong>Try searching by:</strong></p>
                                <ul class="list-unstyled small">
                                    <li>• Order ID (e.g., "123", "#456")</li>
                                    <li>• Product name (e.g., "pizza", "burger")</li>
                                    <li>• Order status (e.g., "delivered", "pending")</li>
                                    <li>• Date (e.g., "jan", "2024", "today")</li>
                                    <li>• Delivery address or option</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><i class="fas fa-magic me-1"></i> <strong>Search features:</strong></p>
                                <ul class="list-unstyled small">
                                    <li>• Real-time search as you type</li>
                                    <li>• Partial word matching</li>
                                    <li>• Case-insensitive search</li>
                                    <li>• Multiple criteria support</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="clearAllFilters();">
                        <i class="fas fa-times me-1"></i> Clear All Filters
                    </button>
                </div>
            `;
            $('#orderListingContainer').prepend(noResultsHtml);
        }
        
        // Helper function to show search error
        function showSearchError(message) {
            const errorHtml = `
                <div id="search-error-message" class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i>${message}
                </div>
            `;
            $('#orderListingContainer').prepend(errorHtml);
            
            // Auto-hide error after 5 seconds
            setTimeout(function() {
                $('#search-error-message').fadeOut();
            }, 5000);
        }
        
        // Helper function to clear all filters
        function clearAllFilters() {
            $('#searchInput').val('');
            $('#statusFilter').val('');
            performAjaxSearch();
        }
        
        // Function to render orders from AJAX response
        function renderOrders(orders) {
            const ordersList = $('#ordersList');
            
            orders.forEach(function(order) {
                // Format date
                const orderDate = new Date(order.orderDate);
                const formattedDate = orderDate.toLocaleDateString('en-GB');
                const formattedTime = orderDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                
                // Format total
                const formattedTotal = new Intl.NumberFormat('en-MY', { 
                    style: 'currency', 
                    currency: 'MYR' 
                }).format(order.total);
                
                // Generate status badge
                let statusBadge = '';
                switch(order.status) {
                    case 'Pending':
                        statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock me-1"></i>Pending</span>';
                        break;
                    case 'Paid':
                        statusBadge = '<span class="status-badge status-paid"><i class="fas fa-check-circle me-1"></i>Paid</span>';
                        break;
                    case 'Preparing':
                        statusBadge = '<span class="status-badge status-preparing"><i class="fas fa-cog me-1"></i>Preparing</span>';
                        break;
                    case 'Ready for Pickup':
                        statusBadge = '<span class="status-badge status-ready"><i class="fas fa-box-open me-1"></i>Ready for Pickup</span>';
                        break;
                    case 'Delivered':
                        statusBadge = '<span class="status-badge status-delivered"><i class="fas fa-truck me-1"></i>Delivered</span>';
                        break;
                    default:
                        statusBadge = `<span class="status-badge">${order.status}</span>`;
                }
                
                // Generate order items HTML
                let itemsHtml = '';
                order.items.forEach(function(item) {
                    const itemTotal = (item.unitPrice * item.quantity).toLocaleString('en-MY', { 
                        style: 'currency', 
                        currency: 'MYR' 
                    });
                    
                    itemsHtml += `
                        <div class="order-item">
                            <div class="item-image">
                                ${item.photoURL ? 
                                    `<img src="${item.photoURL}" alt="${item.menuItemName}" class="img-fluid">` :
                                    '<div class="item-placeholder"><i class="fas fa-image"></i></div>'
                                }
                            </div>
                            <div class="item-details">
                                <div class="item-name order-item-name">${item.menuItemName}</div>
                                <div class="item-quantity">Qty: ${item.quantity}</div>
                                ${item.selectedPersonalizations ? 
                                    `<div class="item-personalization"><i class="fas fa-cog me-1"></i>${item.selectedPersonalizations}</div>` : 
                                    ''
                                }
                            </div>
                            <div class="item-price">${itemTotal}</div>
                        </div>
                    `;
                });
                
                // Generate action buttons based on status
                let actionButtons = '';
                if (order.status === 'Pending') {
                    actionButtons = `
                        <div class="btn-row">
                            <button type="button" class="action-btn btn-warning return-to-payment-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-credit-card"></i>
                                <span>Complete Payment</span>
                            </button>
                            <button type="button" class="action-btn btn-danger cancel-order-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-times"></i>
                                <span>Cancel</span>
                            </button>
                        </div>
                    `;
                } else if (order.status === 'Paid' || order.status === 'Ready for Pickup' || order.status === 'Delivered') {
                    actionButtons = `
                        <div class="btn-row">
                            <button type="button" class="action-btn btn-warning refund-order-btn" data-order-id="${order.orderId}">
                                <i class="fas fa-undo"></i>
                                <span>Refund</span>
                            </button>
                        </div>
                    `;
                }
                
                // Create the complete order card HTML
                const orderCardHtml = `
                    <div class="order-card" data-order-id="${order.orderId}" data-order-date="${order.orderDate}" 
                         data-order-total="${order.total}" data-order-status="${order.status}">
                        <div class="card">
                            <div class="card-header">
                                <div class="order-header">
                                    <div class="order-info">
                                        <div class="order-id">Order #${order.orderId.toString().padStart(6, '0')}</div>
                                        <div class="order-date">${formattedDate}</div>
                                        <div class="order-time">${formattedTime}</div>
                                    </div>
                                    <div class="order-status">
                                        ${statusBadge}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="order-items-section">
                                    <div class="section-title">
                                        <i class="fas fa-utensils me-2"></i>Order Items (${order.itemCount})
                                    </div>
                                    <div class="order-items">
                                        ${itemsHtml}
                                    </div>
                                </div>
                                
                                <div class="order-details-section">
                                    <div class="detail-row">
                                        <i class="fas fa-map-marker-alt text-info me-2"></i>
                                        <span class="detail-label">Delivery:</span>
                                        <span class="detail-value">${order.deliveryOption}</span>
                                    </div>
                                    ${order.deliveryAddress ? `
                                        <div class="detail-row">
                                            <i class="fas fa-home text-secondary me-2"></i>
                                            <span class="detail-label">Address:</span>
                                            <span class="detail-value">${order.deliveryAddress}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="order-footer">
                                    <div class="total-section">
                                        <div class="total-label">Total Amount</div>
                                        <div class="total-amount order-total">${formattedTotal}</div>
                                    </div>
                                    <div class="action-buttons">
                                        <div class="btn-row">
                                            <a href="/Cart/Receipt/${order.orderId}" class="action-btn btn-primary">
                                                <i class="fas fa-receipt"></i>
                                                <span>Receipt</span>
                                            </a>
                                            <a href="/Cart/Track?orderNumber=${order.orderId}" class="action-btn btn-info track-order-btn" data-order-id="${order.orderId}">
                                                <i class="fas fa-truck"></i>
                                                <span>Track</span>
                                            </a>
                                        </div>
                                        <div class="btn-row">
                                            <form action="/Cart/SendReceiptEmail/${order.orderId}" method="post" class="email-form" style="flex:1;">
                                                <input name="__RequestVerificationToken" type="hidden" value="@Html.AntiForgeryToken().ToString().Replace("<input name=\"__RequestVerificationToken\" type=\"hidden\" value=\"", "").Replace("\" />", "")" />
                                                <button type="submit" class="action-btn btn-success email-button w-100" style="min-width:180px;max-width:280px;height:48px;display:flex;align-items:center;justify-content:center;">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>Email</span>
                                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                </button>
                                            </form>
                                            <button type="button" class="action-btn btn-secondary reorder-btn" data-order-id="${order.orderId}">
                                                <i class="fas fa-redo"></i>
                                                <span>Reorder</span>
                                            </button>
                                        </div>
                                        ${actionButtons}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                ordersList.append(orderCardHtml);
            });
        }
        
        // Function to filter orders by status
        function filterOrdersByStatus(status) {
            // Remove any existing search results info
            $('#search-results-info').remove();
            $('#no-results-message').remove();
            
            if (!status) {
                // Show all orders if no status selected
                $('.order-card').show();
            } else {
                // Hide all orders first
                $('.order-card').hide();
                
                // Show orders matching the selected status
                $('.order-card').each(function() {
                    const orderStatus = $(this).data('order-status');
                    if (orderStatus === status) {
                        $(this).show();
                    }
                });
            }
            
            // Check if any orders are visible after filtering
            const visibleOrders = $('.order-card:visible').length;
            
            if (visibleOrders === 0 && status) {
                // Show no results message for status filter
                const noResultsHtml = `
                    <div id="no-results-message" class="alert mt-4 text-center">
                        <div class="mb-3">
                            <i class="fas fa-filter fa-2x text-muted mb-2"></i>
                            <h5>No orders found</h5>
                        </div>
                        <p class="mb-2">No orders found with status: <strong>"${status}"</strong></p>
                        <div class="small text-muted">
                            <p class="mb-2">Try selecting a different status or clear the filter to see all orders.</p>
                        </div>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="$('#statusFilter').val('').trigger('change');">
                            <i class="fas fa-times me-1"></i> Clear Filter
                        </button>
                    </div>
                `;
                $('#orderListingContainer').append(noResultsHtml);
            }
            
            // Reinitialize pagination with filtered results
            initPagination();
        }
        
        // Function to load chart data from the server
        function loadChartData() {
            $.ajax({
                url: '/Cart/GetPurchaseSummaryData',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.error) {
                        console.error('Error loading chart data:', data.error);
                        return;
                    }
                    
                    // Initialize Monthly Spending Chart
                    initMonthlySpendingChart(data.monthlyLabels, data.monthlyData);
                    
                    // Initialize Order Categories Chart
                    initOrderCategoriesChart(data.categoryLabels, data.categoryData);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', error);
                }
            });
        }
        
        // Initialize Monthly Spending Chart
        function initMonthlySpendingChart(labels, data) {
            const ctx = document.getElementById('monthlySpendingChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'RM ' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize Order Categories Chart
        function initOrderCategoriesChart(labels, data) {
            const ctx = document.getElementById('orderCategoriesChart').getContext('2d');
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
                });
        }
    </script>
    <style>
        /* Main Container Styling */
        .order-history-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Enhanced Header Styling */
        .order-history-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .header-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .admin-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .stats-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stats-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stats-item i {
            font-size: 2rem;
        }
        
        .stats-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Search and Filter Section */
        .search-filter-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .search-group {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .search-group .input-group-text {
            border: none;
            color: #6c757d;
        }
        
        .search-group .form-control {
            border: none;
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }
        
        .search-group .form-control:focus {
            box-shadow: none;
        }
        
        .filter-select {
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }
        
        .filter-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
        }
        
        /* Modern Order Card Styling */
        .order-card-modern {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .order-card-modern:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .order-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .order-info {
            margin-bottom: 1rem;
        }
        
        .order-id-section {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .order-id {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .order-date-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
        }
        
        .order-date {
            font-weight: 500;
        }
        
        .order-time {
            background: rgba(108, 117, 125, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .order-status {
            display: flex;
            justify-content: flex-end;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-pending {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: white;
        }

        .status-paid {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .status-preparing {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .status-ready {
            background: linear-gradient(135deg, #fd7e14, #e83e8c);
            color: white;
        }

        .status-delivered {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
        }

        .status-refunded {
            background: linear-gradient(135deg, #fd7e14, #e83e8c);
            color: white;
        }

        .status-declined {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .status-out-for-delivery {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .status-other {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        .order-body {
            background: var(--card-bg);
            padding: 1.5rem;
        }
        
        .order-items-section {
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .section-title {
            font-weight: 600;
            color: #2c3e50;
            margin-right: 0.5rem;
        }
        
        .item-count {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .items-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }
        
        .order-item:hover {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            transform: translateX(5px);
        }
        
        .item-image {
            width: 50px;
            height: 50px;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .item-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .item-placeholder {
            width: 100%;
            height: 100%;
            background: #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        .item-details {
            flex: 1;
            margin-right: 1rem;
        }
        
        .item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .item-quantity {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .item-personalization {
            font-size: 0.8rem;
            color: #495057;
            background: rgba(108, 117, 125, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
        }
        
        .item-price {
            font-weight: 700;
            color: #28a745;
            font-size: 1.1rem;
        }
        
        .order-details-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            margin-right: 0.5rem;
            min-width: 80px;
        }
        
        .detail-value {
            color: #6c757d;
        }
        
        .order-footer {
            border-top: 2px solid #f8f9fa;
            padding-top: 1.5rem;
        }
        
        .total-section {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
        }
        
        .total-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .total-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #28a745;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .btn-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-radius: 12px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .action-btn i {
            margin-right: 4px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .action-btn.btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .action-btn.btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .action-btn.btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        .action-btn.btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        .action-btn.btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .action-btn.btn-warning {
            color: #fff;
            background: #ffc107;
            border-color: #ffc107;
        }
        .order-card .card-header {
            font-size: 1.1rem;
            font-weight: 600;
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .order-card .btn-group .btn {
            margin-bottom: 8px;
        }
        .order-card .btn-group {
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .order-card img {
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .order-card img:hover {
            transform: scale(1.05);
            border-color: #adb5bd;
        }
        .order-card .badge {
            font-size: 1rem;
            padding: 0.5em 1em;
            border-radius: 50px;
        }
        .order-card .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #343a40;
        }
        .order-card .list-group-item {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }
        .order-card .list-group-item:hover {
            background: #e9ecef;
        }
        .order-card .btn {
            font-size: 0.95rem;
            border-radius: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .order-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .order-card .btn i {
            margin-right: 4px;
        }
        .order-card .btn-outline-info {
            color: #0dcaf0;
            border-color: #0dcaf0;
        }
        .order-card .btn-outline-info:hover {
            background: #0dcaf0;
            color: #fff;
        }
        .order-card .btn-outline-success {
            color: #198754;
            border-color: #198754;
        }
        .order-card .btn-outline-success:hover {
            background: #198754;
            color: #fff;
        }
        .order-card .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .order-card .btn-outline-danger:hover {
            background: #dc3545;
            color: #fff;
        }
        .order-card .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        .order-card .btn-outline-primary:hover {
            background: #0d6efd;
            color: #fff;
        }
        .order-card .btn-warning {
            color: #fff;
            background: #ffc107;
            border-color: #ffc107;
        }
        .order-card .btn-secondary {
            color: #fff;
            background: #6c757d;
            border-color: #6c757d;
        }
        .order-card .btn-secondary:hover {
            background: #495057;
            color: #fff;
        }
        .order-card .btn-success {
            color: #fff;
            background: #198754;
            border-color: #198754;
        }
        .order-card .btn-success:hover {
            background: #157347;
            color: #fff;
        }
        .order-card .btn-group .btn:last-child {
            margin-right: 0;
        }
        .order-card .btn-group .btn {
            min-width: 110px;
        }
        .order-card .btn .spinner-border {
            margin-left: 6px;
        }
        
        /* Search and Filter Controls */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-container .form-control {
            border-radius: 50px;
            padding-left: 30px;
            padding-right: 50px;
            height: 45px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        /* Enhanced Search Bar Styling */
        .input-group .form-control {
            border-radius: 0.375rem 0 0 0.375rem;
            border-right: none;
            height: 45px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .input-group .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .input-group .input-group-text {
            border-radius: 0.375rem 0 0 0.375rem;
            border-right: none;
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .input-group .btn {
            height: 45px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .input-group .btn:last-child {
            border-radius: 0 0.375rem 0.375rem 0;
            padding: 0.5rem 1.5rem;
        }
        
        .input-group .btn:not(:last-child) {
            border-radius: 0;
            border-right: 1px solid #dee2e6;
        }
        
        .input-group .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .input-group .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        /* Filter and Sort Controls */
        .form-select {
            height: 45px;
            border-radius: 0.375rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* Search Results Styling */
        #no-results-message {
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        #no-results-message .fas {
            color: #6c757d;
        }
        
        /* Pagination Styling */
        .pagination .page-item .page-link {
            border-radius: 50px;
            margin: 0 5px;
            width: 80px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border: 2px solid #e9ecef;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        /* Enhanced Chart Styling */
        .charts-section {
            margin-bottom: 3rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .chart-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .chart-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .chart-body {
            background: var(--card-bg);
            padding: 1.5rem;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .chart-container canvas {
            max-height: 100%;
            max-width: 100%;
        }
         
         /* Button Ripple Effect */
         .btn-ripple {
             position: absolute;
             background: rgba(255, 255, 255, 0.4);
             border-radius: 50%;
             transform: scale(0);
             animation: ripple 0.6s linear;
             pointer-events: none;
             width: 100px;
             height: 100px;
         }
         
         @@keyframes ripple {
             to {
                 transform: scale(4);
                 opacity: 0;
             }
         }
         
         /* Sort Animation */
         .sort-animation {
             animation: sortFade 0.5s ease;
         }
         
         @@keyframes sortFade {
             0% { opacity: 0.5; transform: translateY(10px); }
             100% { opacity: 1; transform: translateY(0); }
         }
         
         /* Pagination Controls */
         .pagination-controls {
             display: flex;
             justify-content: center;
             align-items: center;
             margin: 30px auto 20px auto;
             gap: 6px;
             background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
             padding: 15px 25px;
             border-radius: 25px;
             box-shadow: 0 4px 15px rgba(0,0,0,0.08);
             flex-wrap: wrap;
             max-width: 800px;
             border: 1px solid rgba(0,0,0,0.05);
         }
         
         .pagination-controls .page-btn {
             min-width: 44px;
             height: 44px;
             border-radius: 12px;
             display: flex;
             align-items: center;
             justify-content: center;
             border: 2px solid #dee2e6;
             background: white;
             color: #495057;
             transition: all 0.2s ease;
             cursor: pointer;
             box-shadow: 0 2px 8px rgba(0,0,0,0.06);
             margin: 0 3px;
             font-weight: 500;
             font-size: 0.9rem;
         }
         
         .pagination-controls .page-btn:hover:not(:disabled) {
             background: linear-gradient(135deg, #007bff, #0056b3);
             color: white;
             border-color: #007bff;
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(0,123,255,0.25);
         }
         
         .pagination-controls .page-btn.active {
             background: linear-gradient(135deg, #007bff, #0056b3);
             border-color: #007bff;
             color: white;
             box-shadow: 0 4px 12px rgba(0,123,255,0.3);
             transform: scale(1.05);
         }
         
         .pagination-controls .page-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             box-shadow: none;
             transform: none;
         }
         
         .pagination-controls .prev-btn,
         .pagination-controls .next-btn,
         .pagination-controls .first-btn,
         .pagination-controls .last-btn {
             font-size: 0.85rem;
             padding: 0 16px;
             border-radius: 12px;
             width: auto;
             min-width: 80px;
             font-weight: 600;
         }
         
         .pagination-controls .page-info {
             font-size: 0.85rem;
             color: #6c757d;
             background: rgba(255,255,255,0.9);
             padding: 10px 18px;
             border-radius: 12px;
             margin-left: 15px;
             box-shadow: 0 2px 8px rgba(0,0,0,0.06);
             display: flex;
             align-items: center;
             border: 1px solid #e9ecef;
             font-weight: 500;
         }
         
         .pagination-controls .page-ellipsis {
             display: inline-flex;
             align-items: center;
             justify-content: center;
             padding: 0 5px;
             font-weight: bold;
             color: #6c757d;
         }
         
         /* Animation for page transitions */
         .order-card.page-transition {
             animation: pageTransition 0.4s ease;
         }
         
         @@keyframes pageTransition {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for return to payment button */
        .pulse-animation {
            animation: pulseGlow 2s infinite;
        }
        
        @@keyframes pulseGlow {
            0% { box-shadow: 0 4px 8px rgba(255,193,7,0.25); }
            50% { box-shadow: 0 6px 15px rgba(255,193,7,0.5); }
            100% { box-shadow: 0 4px 8px rgba(255,193,7,0.25); }
        }
        
        /* Refund Animation Styles */
        .refund-animation {
            animation: refundShrinkPop 3s ease-in-out;
            animation-fill-mode: forwards;
        }
        
        @@keyframes refundShrinkPop {
            0% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            20% {
                transform: scale(0.95);
                box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
            }
            40% {
                transform: scale(0.9);
                box-shadow: 0 6px 30px rgba(255, 87, 34, 0.4);
            }
            60% {
                transform: scale(1.1);
                box-shadow: 0 8px 40px rgba(76, 175, 80, 0.5);
                background: linear-gradient(45deg, #4CAF50, #8BC34A, #CDDC39, #FFEB3B, #FFC107, #FF9800, #FF5722, #E91E63, #9C27B0, #673AB7);
                background-size: 400% 400%;
                animation: rainbow 0.5s ease infinite;
            }
            80% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(0);
                opacity: 0;
                display: none;
            }
        }
        
        @@keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .refund-success-message {
            animation: slideInFromTop 0.5s ease-out;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        @@keyframes slideInFromTop {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        } 
     </style>
}

<!-- Notification alerts for success/error messages -->
<div class="container mt-3">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

        <!-- Enhanced Order History Header -->
    <div class="order-history-header mb-5">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="header-icon me-3">
                        <i class="fas fa-history"></i>
                    </div>
                    <div>
                        <h1 class="page-title mb-1">Order History</h1>
                        <p class="page-subtitle text-muted">Track and manage your past orders</p>
                    </div>
                </div>
                @if (User.IsInRole("Admin"))
                {
                    <a href="@Url.Action("Orders", "Admin")" class="btn btn-outline-primary admin-btn">
                        <i class="fas fa-cog me-2"></i>Manage All Orders
                    </a>
                }
            </div>
            <div class="col-lg-4">
                <div class="stats-card">
                    <div class="stats-item">
                        <i class="fas fa-shopping-bag text-primary"></i>
                        <div>
                            <span class="stats-number">@Model.Orders.Count</span>
                            <span class="stats-label">Total Orders</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Search and Filter Section -->
        <div class="search-filter-section mt-4">
            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="input-group search-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search orders by ID, date, product name, or related items..." aria-label="Search orders">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search me-1"></i> Search
                        </button>
                    </div>
                </div>
                <div class="col-lg-3">
                    <select id="statusFilter" class="form-select filter-select">
                        <option value="" selected="@(string.IsNullOrEmpty(selectedStatus))">
                            <i class="fas fa-filter me-2"></i>All Statuses
                        </option>
                        <option value="Pending" selected="@(selectedStatus == "Pending")">🟡 Pending</option>
                        <option value="Paid" selected="@(selectedStatus == "Paid")">🟢 Paid</option>
                        <option value="Preparing" selected="@(selectedStatus == "Preparing")">🔵 Preparing</option>
                        <option value="Ready for Pickup" selected="@(selectedStatus == "Ready for Pickup")">🟠 Ready for Pickup</option>
                        <option value="Delivered" selected="@(selectedStatus == "Delivered")">🟣 Delivered</option>
                    </select>
                </div>
                <div class="col-lg-3">
                    <select id="sortOptions" class="form-select filter-select">
                        <option value="date-newest">📅 Newest First</option>
                        <option value="date-oldest">📅 Oldest First</option>
                        <option value="price-highest">💰 Highest Amount</option>
                        <option value="price-lowest">💰 Lowest Amount</option>
                        <option value="status-asc">📊 Status A-Z</option>
                        <option value="status-desc">📊 Status Z-A</option>
                        <option value="id-asc">🔢 Order ID (Low-High)</option>
                        <option value="id-desc">🔢 Order ID (High-Low)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Purchase Summary Charts -->
    <div class="charts-section mb-5">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            Monthly Spending
                        </div>
                        <div class="chart-subtitle">Your spending trends over time</div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="monthlySpendingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie text-success me-2"></i>
                            Order Categories
                        </div>
                        <div class="chart-subtitle">Distribution of your purchases</div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="orderCategoriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Order listing container with pagination -->
    <div id="orderListingContainer">
        <!-- Displays a message if no orders exist;
        otherwise, lists each past order with details,
        items, total price, and a link to view the receipt,
        with two orders side by side per row. -->
        @if (!Model.Orders.Any())
        {
            <div class="text-center empty-cart py-4">
                <i class="fas fa-solid fa-clipboard-list fa-3x mb-3"></i>
                <p class="in-the-middle lead">You have no past orders.</p>
                <a asp-action="Index" asp-controller="MenuItem" class="btn btn-primary">Start Shopping</a>
            </div>
        }
        else
        {
            <div class="row" id="ordersList">
                @foreach (var order in Model.Orders)
                {
                    <div class="col-lg-6 col-xl-4 mb-4 order-card" data-order-id="@order.OrderId" data-order-date="@order.OrderDate.ToString("yyyy-MM-ddTHH:mm:ss")" data-order-total="@order.Total" data-order-status="@order.Status" data-order-items="@string.Join(",", order.Items.Select(i => i.MenuItemName))">
                        <div class="order-card-modern">
                            <div class="order-header">
                                <div class="order-info">
                                    <div class="order-id-section">
                                        <i class="fas fa-receipt text-primary me-2"></i>
                                        <span class="order-id">Order #@order.OrderId</span>
                                    </div>
                                    <div class="order-date-section">
                                        <i class="fas fa-calendar-alt text-muted me-2"></i>
                                        <span class="order-date">@order.OrderDate.ToString("MMM dd, yyyy")</span>
                                        <span class="order-time">@order.OrderDate.ToString("HH:mm")</span>
                                    </div>
                                </div>
                                <div class="order-status">
                                    @if (order.Status == "Pending")
                                    {
                                        <span class="status-badge status-pending">
                                            <i class="fas fa-clock me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Paid")
                                    {
                                        <span class="status-badge status-paid">
                                            <i class="fas fa-check-circle me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Preparing")
                                    {
                                        <span class="status-badge status-preparing">
                                            <i class="fas fa-cog me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Ready for Pickup")
                                    {
                                        <span class="status-badge status-ready">
                                            <i class="fas fa-box-open me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Delivered")
                                    {
                                        <span class="status-badge status-delivered">
                                            <i class="fas fa-truck me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Refunded")
                                    {
                                        <span class="status-badge status-refunded">
                                            <i class="fas fa-undo me-1"></i>@order.Status
                                        </span>
                                    }
                                    else if (order.Status == "Declined")
                                    {
                                        <span class="status-badge status-declined">
                                            <i class="fas fa-times-circle me-1"></i>@order.Status
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-other">
                                            <i class="fas fa-info-circle me-1"></i>@order.Status
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="order-body">
                                <div class="order-items-section">
                                    <div class="section-header">
                                        <i class="fas fa-shopping-basket text-primary me-2"></i>
                                        <span class="section-title">Order Items</span>
                                        <span class="item-count">(@order.Items.Count items)</span>
                                    </div>
                                    <div class="items-list">
                                        @foreach (var item in order.Items)
                                        {
                                            <div class="order-item">
                                                <div class="item-image">
                                                    @if (!string.IsNullOrEmpty(item.PhotoURL))
                                                    {
                                                        <img src="/Images/@item.PhotoURL" alt="@item.MenuItemName" class="item-img">
                                                    }
                                                    else
                                                    {
                                                        <div class="item-placeholder">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="item-details">
                                                    <div class="item-name order-item-name">@item.MenuItemName</div>
                                                    <div class="item-quantity">Qty: @item.Quantity</div>
                                                    @if (!string.IsNullOrEmpty(item.SelectedPersonalizations))
                                                    {
                                                        <div class="item-personalization">
                                                            <i class="fas fa-cog me-1"></i>@item.SelectedPersonalizations
                                                        </div>
                                                    }
                                                </div>
                                                <div class="item-price">@((item.UnitPrice * item.Quantity).ToString("C", new CultureInfo("en-MY")))</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                
                                <div class="order-details-section">
                                    <div class="detail-row">
                                        <i class="fas fa-map-marker-alt text-info me-2"></i>
                                        <span class="detail-label">Delivery:</span>
                                        <span class="detail-value">@order.DeliveryOption</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(order.DeliveryAddress))
                                    {
                                        <div class="detail-row">
                                            <i class="fas fa-home text-secondary me-2"></i>
                                            <span class="detail-label">Address:</span>
                                            <span class="detail-value">@order.DeliveryAddress</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="order-footer">
                                    <div class="total-section">
                                        <div class="total-label">Total Amount</div>
                                        <div class="total-amount order-total">@order.Total.ToString("C", new CultureInfo("en-MY"))</div>
                                    </div>
                                    <div class="action-buttons">
                                        <div class="btn-row">
                                            <a asp-action="Receipt" asp-controller="Cart" asp-route-id="@order.OrderId" class="action-btn btn-primary">
                                                <i class="fas fa-receipt"></i>
                                                <span>Receipt</span>
                                            </a>
                                            <a asp-action="Track" asp-controller="Cart" asp-route-orderNumber="@order.OrderId" class="action-btn btn-info track-order-btn" data-order-id="@order.OrderId">
                                                <i class="fas fa-truck"></i>
                                                <span>Track</span>
                                            </a>
                                        </div>
                                        <div class="btn-row">
                                            <form asp-action="SendReceiptEmail" asp-controller="Cart" asp-route-id="@order.OrderId" method="post" class="email-form" style="flex:1;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="action-btn btn-success email-button w-100" style="min-width:180px;max-width:280px;height:48px;display:flex;align-items:center;justify-content:center;">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>Email</span>
                                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                </button>
                                            </form>
                                            <button type="button" class="action-btn btn-secondary reorder-btn" data-order-id="@order.OrderId">
                                                <i class="fas fa-redo"></i>
                                                <span>Reorder</span>
                                            </button>
                                        </div>
                                        @if (order.Status == "Pending")
                                        {
                                            <div class="btn-row">
                                                <button type="button" class="action-btn btn-warning return-to-payment-btn" data-order-id="@order.OrderId">
                                                    <i class="fas fa-credit-card"></i>
                                                    <span>Complete Payment</span>
                                                </button>
                                                <button type="button" class="action-btn btn-danger cancel-order-btn" data-order-id="@order.OrderId">
                                                    <i class="fas fa-times"></i>
                                                    <span>Cancel</span>
                                                </button>
                                            </div>
                                        }
                                        else if (order.Status == "Paid" || order.Status == "Ready for Pickup" || order.Status == "Delivered")
                                        {
                                            <div class="btn-row">
                                                <button type="button" class="action-btn btn-warning refund-order-btn" data-order-id="@order.OrderId">
                                                    <i class="fas fa-undo"></i>
                                                    <span>Refund</span>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <!-- Custom pagination controls will be dynamically generated here -->
        }
    </div>

    <!-- Order Cancellation Modal -->
    <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
                    <p>If you proceed, you will receive an SMS notification confirming the cancellation.</p>
                    <div class="form-group">
                        <label for="cancelReason">Reason for cancellation (optional):</label>
                        <textarea id="cancelReason" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelOrder">Cancel Order</button>
                </div>
            </div>
        </div>
    </div>
</div>