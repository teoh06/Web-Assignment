@model List<WebApplication2.Models.User>
@Html.AntiForgeryToken()

@{
    var selectedRole = Context.Request.Query["role"].ToString();
    var selectedStatus = Context.Request.Query["status"].ToString();
    var roleOptions =
        "<option value=\"\"" + (string.IsNullOrEmpty(selectedRole) ? " selected" : "") + ">All Roles</option>" +
        "<option value=\"Admin\"" + (selectedRole == "Admin" ? " selected" : "") + ">Admin</option>" +
        "<option value=\"Member\"" + (selectedRole == "Member" ? " selected" : "") + ">Member</option>";
    var statusOptions =
        "<option value=\"\"" + (string.IsNullOrEmpty(selectedStatus) ? " selected" : "") + ">All Status</option>" +
        "<option value=\"Active\"" + (selectedStatus == "Active" ? " selected" : "") + ">Active</option>" +
        "<option value=\"Pending\"" + (selectedStatus == "Pending" ? " selected" : "") + ">Pending Deletion</option>";
    var roleSelect = $"<select class=\"form-select me-2\" id=\"roleFilter\" name=\"role\" aria-label=\"Filter by role\" style=\"max-width:140px;\">{roleOptions}</select>";
    var statusSelect = $"<select class=\"form-select me-2\" id=\"statusFilter\" name=\"status\" aria-label=\"Filter by status\" style=\"max-width:170px;\">{statusOptions}</select>";
}

<div class="admin-manage-users-enhanced">
    <div class="users-section-header">
        <div class="section-title-area">
            <h3 class="admin-subtitle"><i class="fas fa-users"></i> User Management</h3>
            <p class="section-description">Manage user accounts, roles, and permissions</p>
        </div>
        <div class="users-stats-grid">
            <div class="stat-card admins">
                <div class="stat-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number">@Model.Count(u => u.Role == "Admin")</span>
                    <span class="stat-label">Administrators</span>
                </div>
            </div>
            <div class="stat-card members">
                <div class="stat-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number">@Model.Count(u => u.Role == "Member")</span>
                    <span class="stat-label">Members</span>
                </div>
            </div>
            <div class="stat-card pending">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number">@Model.Count(u => u.IsPendingDeletion)</span>
                    <span class="stat-label">Pending Deletion</span>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number">@Model.Count()</span>
                    <span class="stat-label">Total Users</span>
                </div>
            </div>
        </div>
    </div>

    <div class="users-grid-enhanced">
        @foreach (var user in Model)
        {
            <div class="user-card-enhanced" data-user-email="@user.Email">
                <div class="user-card-header">
                    <div class="user-avatar-section">
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-basic-info">
                            <span class="user-name">@user.Name</span>
                            <span class="user-email">@user.Email</span>
                        </div>
                    </div>
                    <div class="user-badges">
                        <span class="role-badge role-@user.Role.ToLower()">
                            <i class="fas @(user.Role == "Admin" ? "fa-shield-alt" : "fa-user")"></i>
                            @user.Role
                        </span>
                        @if (user.IsPendingDeletion)
                        {
                            <span class="status-badge status-pending">
                                <i class="fas fa-clock"></i> Pending Deletion
                            </span>
                        }
                        else
                        {
                            <span class="status-badge status-active">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        }
                    </div>
                </div>
                
                <div class="user-card-body">
                    <div class="user-details">
                        <div class="detail-item">
                            <span class="detail-label">Account Status</span>
                            <span class="detail-value">@(user.IsPendingDeletion ? "Scheduled for deletion" : "Active account")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">User Role</span>
                            <span class="detail-value">@user.Role privileges</span>
                        </div>
                    </div>
                </div>
                
                <div class="user-card-footer">
                    <div class="user-actions-enhanced">
                        @if (!user.IsPendingDeletion)
                        {
                            <form asp-controller="Account" asp-action="Delete" method="post" style="display:inline">
                                <input type="hidden" name="email" value="@user.Email" />
                                <button type="submit" class="btn btn-danger btn-sm delete-btn" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
                            </form>
                        }
                        else
                        {
                            <form asp-controller="Account" asp-action="Restore" method="post" style="display:inline">
                                <input type="hidden" name="token" value="@user.DeletionToken" />
                                <button type="submit" class="btn btn-info btn-sm restore-btn">Restore</button>
                            </form>
                        }

                        @if (user.Role != "Admin" && !user.IsPendingDeletion)
                        {
                            <form asp-controller="Admin" asp-action="PromoteToAdmin" method="post" style="display:inline">
                                <input type="hidden" name="email" value="@user.Email" />
                                <button type="submit" class="btn btn-success btn-sm promote-btn" onclick="return confirm('Promote this user to Admin?')">Promote to Admin</button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Processing...</p>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>
