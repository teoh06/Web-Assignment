@model WebApplication2.Models.MenuItemDetailsVM
@using WebApplication2.Models;
@{
    ViewBag.Title = "Menu Item Details";
    var menuItem = Model.MenuItem;
    var db = Context.RequestServices.GetService(typeof(DB)) as DB;
    var options = db.PersonalizationOptions.Where(o => o.CategoryId == menuItem.CategoryId).ToList();
}
@if (TempData["EditMessage"] != null)
{
    <div class="alert alert-info" role="alert">
        @Html.Raw(TempData["EditMessage"])
    </div>
}
<div class="card mb-4 menuitem-details-card">
    <div class="row g-0">
        <div class="col-md-5">
            <div id="menuitem-gallery" class="swiper-container">
                <div class="swiper-wrapper">
                    @if (menuItem.MenuItemImages != null && menuItem.MenuItemImages.Count > 0)
                    {
                        var img = menuItem.MenuItemImages.First();
                        <div class="swiper-slide">
                            <img src="/images/@img.FileName" class="img-fluid rounded-start menuitem-photo mx-2 my-2 mt-4" alt="@menuItem.Name">
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(menuItem.PhotoURL))
                    {
                        <div class="swiper-slide">
                            <img src="@(menuItem.PhotoURL.StartsWith("http") ? menuItem.PhotoURL : "/images/" + menuItem.PhotoURL)" class="img-fluid rounded-start menuitem-photo mx-2 my-2 mt-4" alt="@menuItem.Name">
                        </div>
                    }
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card-body m-3">
                <h3 class="card-title mb-4">@menuItem.Name</h3>
                <h5 class="card-subtitle mb-2 mt-4 my-muted">@menuItem.Category?.Name</h5>
                <p class="card-text">@menuItem.Description</p>
                <h4 class="text-success">@menuItem.Price.ToString("C", new System.Globalization.CultureInfo("en-MY"))</h4>
                <br>

                @if (User.IsInRole("Member"))
                {
                <div class="mb-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="toggleFavorite(this)"><span id="fav-icon">♡</span> Favorite</button>
                </div>
                <div class="mb-2 rating-summary">
                    <span id="avg-rating" class="fw-bold">@Model.AverageRating.ToString("0.0")</span> / 5
                    <span class="ms-2">(@Model.RatingsCount ratings)</span>
                </div>
                <div class="mb-2">
                    <label>Rate this item:</label>
                    <span id="user-rating">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <span class="star" data-value="@i" style="font-size:1.5em; cursor:pointer; color:gold;">☆</span>
                        }
                    </span>
                </div>
                }
                else
                {
                    <p><b>Only Member can order.</b></p>
                }

                @if (User.IsInRole("Admin"))
                {
                    <a href="@Url.Action("Edit", new { id = menuItem.MenuItemId })" class="btn btn-primary">Edit</a>
                }
                <a href="@Url.Action("Index")" class="btn btn-secondary">Back to List</a>
                @if (User.IsInRole("Member"))
                {
                    <form asp-controller="Cart" asp-action="Add" method="post" style="display:inline" id="addToCartForm">
                        <input type="hidden" name="menuItemId" value="@menuItem.MenuItemId" />
                        <input type="number" name="quantity" value="1" min="1" max="100" style="width:60px" />
                        @if (options.Any())
                        {
                            <div class="mb-2">
                                <label>Personalization:</label>
                                <div>
                                    @foreach (var opt in options)
                                    {
                                        <label class="me-2">
                                            <input type="checkbox" name="personalizations" value="@opt.Name" /> @opt.Name
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                        <input type="hidden" name="SelectedPersonalizations" id="SelectedPersonalizations" />
                        <button type="submit" class="btn btn-success" onclick="collectPersonalizations(event)">Add to Cart</button>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<div class="card mt-4 menuitem-comments-card">
    <div class="card-header my-muted">Comments</div>
    <div class="card-body">
        <div id="comments-list">
        <div id="comments-list">
            @foreach (var c in Model.Comments)
            {
                <div class="mb-2 comment-item"><b>@c.Member?.Name (Foodie Voice)</b>: @c.Content <span class="my-muted small">(@c.CommentedAt.ToShortTimeString())</span></div>
            }
        </div>
        @if (User.Identity!.IsAuthenticated)
        {
            <form id="comment-form" onsubmit="addComment(event)">
                <div class="input-group">
                    <input type="text" id="comment-input" class="form-control" placeholder="Add a comment..." maxlength="200" required />
                    <button type="submit" class="btn btn-outline-primary">Post</button>
                </div>
            </form>
        }
        else
        {
            <div class="my-muted">Login to add a comment.</div>
        }
    </div>
    </div>
</div>

@section Scripts {
<script src="https://unpkg.com/swiper@10/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/swiper@10/swiper-bundle.min.css" />
<script>
    var swiper = new Swiper('#menuitem-gallery', {
        loop: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        slidesPerView: 1,
        spaceBetween: 10,
    });
function toggleFavorite(btn) {
    var icon = document.getElementById('fav-icon');
    if (icon.textContent === '♡') {
        icon.textContent = '♥';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-danger');
    } else {
        icon.textContent = '♡';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-outline-danger');
    }
}
// Star rating AJAX
const stars = document.querySelectorAll('.star');
stars.forEach(star => {
    star.addEventListener('mouseover', function() {
        const val = parseInt(this.getAttribute('data-value'));
        stars.forEach((s, i) => s.textContent = i < val ? '★' : '☆');
    });
    star.addEventListener('mouseout', function() {
        stars.forEach(s => s.textContent = '☆');
    });
    star.addEventListener('click', function() {
        const val = this.getAttribute('data-value');
        fetch('@Url.Action("AddRating", "MenuItem")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            body: `menuItemId=@menuItem.MenuItemId&value=${val}`
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('avg-rating').textContent = data.avg.toFixed(1);
            document.querySelector('.rating-summary .ms-2').textContent = `(${data.count} ratings)`;
            alert('Thank you for rating ' + val + ' stars!');
        });
    });
});
// Comment AJAX
function addComment(e) {
    e.preventDefault();
    var input = document.getElementById('comment-input');
    var list = document.getElementById('comments-list');
    if (input.value.trim()) {
        fetch('@Url.Action("AddComment", "MenuItem")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            body: `menuItemId=@menuItem.MenuItemId&content=${encodeURIComponent(input.value)}`
        })
        .then(r => r.json())
        .then(data => {
            var div = document.createElement('div');
            div.className = 'mb-2 comment-item';
            div.innerHTML = `<b>You</b>: ${data.content} <span class='my-muted small'>(just now)</span>`;
            list.prepend(div);
            input.value = '';
        });
    }
}

function collectPersonalizations(e) {
    var checked = Array.from(document.querySelectorAll('input[name="personalizations"]:checked')).map(x => x.value);
    document.getElementById('SelectedPersonalizations').value = checked.join(',');
}

document.getElementById('addToCartForm').addEventListener('submit', function(e) {
    e.preventDefault();
    collectPersonalizations(e);
    var form = e.target;
    var formData = new FormData(form);
    var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
    fetch(form.action, {
        method: 'POST',
        headers: {
            'RequestVerificationToken': token
        },
        body: new URLSearchParams([...formData])
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert(data.message || 'Failed to add to cart.');
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        alert('Something went wrong.');
    });
})
</script>
}
